<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-2 sm:p-4">
    <div id="app"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, query, where, getDocs, addDoc, deleteDoc, doc, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCv0Yom3XNZ5lYytJuI62hOYn1HC4kgzxQ",
            authDomain: "workout-tracker-b56d1.firebaseapp.com",
            projectId: "workout-tracker-b56d1",
            storageBucket: "workout-tracker-b56d1.firebasestorage.app",
            messagingSenderId: "169629117227",
            appId: "1:169629117227:web:cdc112641c9242eb73336e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let state = {
            username: localStorage.getItem('username') || '',
            workouts: [],
            currentWorkout: null,
            activeExercises: [],
            showLogger: false,
            selectedDate: new Date().toISOString().split('T')[0],
            workoutNotes: ''
        };

        async function loadWorkouts() {
            if (!state.username) return;
            
            try {
                const q = query(
                    collection(db, 'workouts'),
                    where('username', '==', state.username),
                    orderBy('date', 'desc')
                );
                const querySnapshot = await getDocs(q);
                state.workouts = [];
                querySnapshot.forEach((doc) => {
                    state.workouts.push({ id: doc.id, ...doc.data() });
                });
                render();
            } catch (error) {
                console.error('Error loading workouts:', error);
            }
        }

        async function saveWorkout() {
            const workout = {
                username: state.username,
                ...state.currentWorkout,
                exercises: state.activeExercises,
                notes: state.workoutNotes,
                completedAt: new Date().toISOString()
            };
            
            try {
                await addDoc(collection(db, 'workouts'), workout);
                await loadWorkouts();
                state.showLogger = false;
                state.currentWorkout = null;
                state.activeExercises = [];
                state.workoutNotes = '';
                render();
            } catch (error) {
                console.error('Error saving workout:', error);
                alert('Failed to save workout. Please try again.');
            }
        }

        async function deleteWorkout(id) {
            if (confirm('Delete this workout?')) {
                try {
                    await deleteDoc(doc(db, 'workouts', id));
                    await loadWorkouts();
                } catch (error) {
                    console.error('Error deleting workout:', error);
                    alert('Failed to delete workout.');
                }
            }
        }

        function setUsername() {
            const input = document.getElementById('usernameInput');
            const username = input.value.trim();
            if (username) {
                state.username = username;
                localStorage.setItem('username', username);
                loadWorkouts();
            }
        }

        function logout() {
            state.username = '';
            state.workouts = [];
            localStorage.removeItem('username');
            render();
        }

        const workoutTemplates = {
            A: {
                name: 'Workout A - Machine + Dumbbell',
                exercises: [
                    { name: 'Dumbbell Goblet Squat', sets: 3, reps: '10-12', type: 'main' },
                    { name: 'Lat Pulldown', sets: 3, reps: '10-12', type: 'main' },
                    { name: 'Dumbbell Chest Press', sets: 3, reps: '10-12', type: 'main' },
                    { name: 'Seated Cable Row', sets: 3, reps: '10-12', type: 'main' },
                    { name: 'Dumbbell RDLs', sets: 3, reps: '10-12', type: 'main' },
                    { name: 'Plank', sets: 3, reps: '30 sec', type: 'core' },
                    { name: 'Deadbugs/Knee Raises', sets: 3, reps: '10', type: 'core' }
                ]
            },
            B: {
                name: 'Workout B - Bodyweight + Machines',
                exercises: [
                    { name: 'Smith Machine Squats', sets: 3, reps: '8-10', type: 'main' },
                    { name: 'Machine Chest Press', sets: 3, reps: '10', type: 'main' },
                    { name: 'Assisted Pull-Up/Lat Pulldown', sets: 3, reps: '10-12', type: 'main' },
                    { name: 'Leg Curl Machine', sets: 3, reps: '10-12', type: 'main' },
                    { name: 'Farmer Carries', sets: 2, reps: '30 sec', type: 'main' },
                    { name: 'Mobility Stretches', sets: 1, reps: '5 min', type: 'mobility' }
                ]
            },
            C: {
                name: 'Workout C - Push/Pull Blend',
                exercises: [
                    { name: 'Leg Press Machine', sets: 3, reps: '10-12', type: 'main' },
                    { name: 'Cable Face Pulls', sets: 3, reps: '12-15', type: 'main' },
                    { name: 'Dumbbell Shoulder Press', sets: 3, reps: '10', type: 'main' },
                    { name: 'Cable Rope Triceps Extensions', sets: 3, reps: '12', type: 'main' },
                    { name: 'Dumbbell Bicep Curls', sets: 3, reps: '12', type: 'main' },
                    { name: 'Core Work', sets: 3, reps: '10-20', type: 'core' }
                ]
            },
            Mobility: {
                name: 'Mobility Only',
                exercises: [
                    { name: 'Full Body Mobility', sets: 1, reps: '10 min', type: 'mobility' }
                ]
            }
        };

        function startWorkout(type) {
            const template = workoutTemplates[type];
            state.activeExercises = template.exercises.map(ex => ({
                ...ex,
                completedSets: Array(ex.sets).fill(null).map(() => ({ weight: '', reps: '', completed: false }))
            }));
            state.currentWorkout = { type, name: template.name, date: state.selectedDate };
            state.workoutNotes = '';
            state.showLogger = true;
            render();
        }

        function cancelWorkout() {
            state.showLogger = false;
            state.currentWorkout = null;
            state.activeExercises = [];
            render();
        }

        function exportCSV() {
            let csv = 'Date,Workout Type,Exercise,Set,Weight,Reps,Completed,Notes\n';
            state.workouts.forEach(workout => {
                workout.exercises.forEach(exercise => {
                    exercise.completedSets.forEach((set, idx) => {
                        csv += `"${workout.date}","${workout.type}","${exercise.name}",${idx + 1},"${set.weight || 'N/A'}","${set.reps || 'N/A'}",${set.completed ? 'Yes' : 'No'},"${workout.notes || ''}"\n`;
                    });
                });
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `workout-data-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function getStats() {
            const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            const weekWorkouts = state.workouts.filter(w => new Date(w.date) >= weekAgo);
            
            let streak = 0;
            if (state.workouts.length > 0) {
                const dates = [...new Set(state.workouts.map(w => w.date))].sort((a, b) => new Date(b) - new Date(a));
                let current = new Date();
                current.setHours(0, 0, 0, 0);
                
                for (let date of dates) {
                    const d = new Date(date);
                    d.setHours(0, 0, 0, 0);
                    const diff = Math.floor((current - d) / (1000 * 60 * 60 * 24));
                    if (diff <= 1) {
                        streak++;
                        current = d;
                    } else break;
                }
            }
            
            return { weekCount: weekWorkouts.length, streak, total: state.workouts.length };
        }

        function updateSet(exIdx, setIdx, field, value) {
            state.activeExercises[exIdx].completedSets[setIdx][field] = value;
        }

        function toggleComplete(exIdx, setIdx) {
            state.activeExercises[exIdx].completedSets[setIdx].completed = !state.activeExercises[exIdx].completedSets[setIdx].completed;
            render();
        }

        function updateExerciseName(idx, name) {
            state.activeExercises[idx].name = name;
        }

        function removeExercise(idx) {
            state.activeExercises.splice(idx, 1);
            render();
        }

        function addExercise() {
            state.activeExercises.push({
                name: 'New Exercise',
                sets: 3,
                reps: '10',
                type: 'main',
                completedSets: Array(3).fill(null).map(() => ({ weight: '', reps: '', completed: false }))
            });
            render();
        }

        function render() {
            const app = document.getElementById('app');

            if (!state.username) {
                app.innerHTML = `
                    <div class="max-w-md mx-auto mt-20">
                        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 text-center">
                            <h1 class="text-4xl font-bold text-white mb-6">üí™ Workout Tracker</h1>
                            <p class="text-purple-200 mb-6">Enter your username to get started</p>
                            <input type="text" id="usernameInput" placeholder="Your username" class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white text-center mb-4 focus:outline-none focus:border-purple-400">
                            <button onclick="window.setUsername()" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-semibold py-3 rounded-xl">Start Tracking</button>
                        </div>
                    </div>
                `;
                return;
            }

            const stats = getStats();

            if (state.showLogger) {
                app.innerHTML = `
                    <div class="max-w-4xl mx-auto">
                        <div class="bg-white/10 backdrop-blur-lg rounded-xl p-4 sm:p-6 mb-4">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h2 class="text-xl sm:text-2xl font-bold text-white">${state.currentWorkout.name}</h2>
                                    <p class="text-sm text-purple-200">${state.currentWorkout.date}</p>
                                </div>
                                <button onclick="window.cancelWorkout()" class="p-2 bg-red-500/20 hover:bg-red-500/30 rounded-lg text-red-200 text-2xl">‚úï</button>
                            </div>
                        </div>

                        <div class="space-y-3" id="exercises"></div>

                        <button onclick="window.addExercise()" class="w-full mt-3 bg-white/10 hover:bg-white/20 border border-dashed border-white/30 rounded-xl p-3 text-white text-sm">+ Add Exercise</button>

                        <div class="bg-white/10 rounded-xl p-4 mt-3">
                            <label class="text-white font-semibold mb-2 block text-sm">üìù Workout Notes</label>
                            <textarea id="notes" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm min-h-20" placeholder="How did you feel?">${state.workoutNotes}</textarea>
                        </div>

                        <button onclick="window.saveWorkout()" class="w-full mt-4 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-semibold py-3 rounded-xl text-sm sm:text-base">Complete Workout</button>
                    </div>
                `;

                const exercisesDiv = document.getElementById('exercises');
                exercisesDiv.innerHTML = state.activeExercises.map((ex, exIdx) => `
                    <div class="bg-white/10 rounded-xl p-3">
                        <div class="flex justify-between items-center mb-2">
                            <input type="text" value="${ex.name}" onchange="window.updateExerciseName(${exIdx}, this.value)" class="text-base font-semibold text-white bg-transparent border-b border-transparent hover:border-white/30 focus:border-purple-400 focus:outline-none flex-1">
                            <span class="text-xs bg-purple-500/20 text-purple-200 px-2 py-1 rounded-full ml-2">${ex.type}</span>
                            <button onclick="window.removeExercise(${exIdx})" class="ml-2 text-red-200 text-lg">üóëÔ∏è</button>
                        </div>
                        <p class="text-purple-200 text-xs mb-2">Target: ${ex.sets} sets √ó ${ex.reps} reps</p>
                        ${ex.completedSets.map((set, setIdx) => `
                            <div class="flex gap-2 items-center mb-2">
                                <span class="text-white text-xs w-12">Set ${setIdx + 1}</span>
                                ${ex.type !== 'mobility' ? `
                                    <input type="number" placeholder="Weight" value="${set.weight}" onchange="window.updateSet(${exIdx}, ${setIdx}, 'weight', this.value)" class="flex-1 bg-white/5 border border-white/10 rounded px-2 py-1 text-white text-sm">
                                    <input type="number" placeholder="Reps" value="${set.reps}" onchange="window.updateSet(${exIdx}, ${setIdx}, 'reps', this.value)" class="flex-1 bg-white/5 border border-white/10 rounded px-2 py-1 text-white text-sm">
                                ` : '<span class="flex-1 text-purple-200 text-xs">Completed</span>'}
                                <button onclick="window.toggleComplete(${exIdx}, ${setIdx})" class="px-3 py-1 rounded text-sm ${set.completed ? 'bg-green-500 text-white' : 'bg-white/10 text-white/50'}">‚úì</button>
                            </div>
                        `).join('')}
                    </div>
                `).join('');
                
                document.getElementById('notes').addEventListener('input', (e) => {
                    state.workoutNotes = e.target.value;
                });

            } else {
                app.innerHTML = `
                    <div class="max-w-6xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <div class="text-center flex-1">
                                <h1 class="text-3xl sm:text-4xl font-bold text-white mb-2">üí™ Workout Tracker</h1>
                                <p class="text-sm text-purple-200">Welcome back, ${state.username}!</p>
                            </div>
                            <button onclick="window.logout()" class="bg-red-500/20 hover:bg-red-500/30 text-red-200 px-4 py-2 rounded-lg text-sm">Logout</button>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-6">
                            <div class="bg-gradient-to-br from-purple-500/20 to-pink-500/20 rounded-xl p-4 border border-white/10">
                                <h3 class="text-white font-semibold text-sm mb-2">üìÖ This Week</h3>
                                <p class="text-2xl font-bold text-white">${stats.weekCount} workouts</p>
                                <p class="text-purple-200 text-xs">Goal: 3-5 per week</p>
                            </div>
                            <div class="bg-gradient-to-br from-orange-500/20 to-red-500/20 rounded-xl p-4 border border-white/10">
                                <h3 class="text-white font-semibold text-sm mb-2">üî• Streak</h3>
                                <p class="text-2xl font-bold text-white">${stats.streak} days</p>
                                <p class="text-orange-200 text-xs">Keep it going!</p>
                            </div>
                            <div class="bg-gradient-to-br from-green-500/20 to-teal-500/20 rounded-xl p-4 border border-white/10">
                                <h3 class="text-white font-semibold text-sm mb-2">üèÜ Total</h3>
                                <p class="text-2xl font-bold text-white">${stats.total}</p>
                                <p class="text-green-200 text-xs">All time</p>
                            </div>
                        </div>

                        <div class="bg-white/10 rounded-xl p-4 mb-4">
                            <h2 class="text-xl font-bold text-white mb-3">‚ûï Start New Workout</h2>
                            <input type="date" value="${state.selectedDate}" onchange="state.selectedDate = this.value" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white mb-3 text-sm">
                            <div class="grid grid-cols-2 lg:grid-cols-4 gap-2">
                                ${Object.keys(workoutTemplates).map(key => `
                                    <button onclick="window.startWorkout('${key}')" class="bg-gradient-to-br from-purple-500/30 to-pink-500/30 hover:from-purple-500/50 hover:to-pink-500/50 border border-white/20 rounded-xl p-4 text-left">
                                        <h3 class="text-base font-bold text-white">Workout ${key}</h3>
                                        <p class="text-purple-200 text-xs">${workoutTemplates[key].exercises.length} exercises</p>
                                    </button>
                                `).join('')}
                            </div>
                        </div>

                        ${state.workouts.length > 0 ? `
                            <div class="flex justify-end mb-4">
                                <button onclick="window.exportCSV()" class="bg-gradient-to-r from-green-500/30 to-teal-500/30 border border-white/20 text-white font-semibold px-4 py-2 rounded-xl text-sm">üì• Export CSV</button>
                            </div>
                        ` : ''}

                        <div class="bg-white/10 rounded-xl p-4">
                            <h2 class="text-xl font-bold text-white mb-3">Recent Workouts</h2>
                            ${state.workouts.length === 0 ? '<p class="text-purple-200 text-center py-6 text-sm">No workouts yet!</p>' : `
                                <div class="space-y-2">
                                    ${state.workouts.slice(0, 10).map(w => `
                                        <div class="bg-white/5 rounded-lg p-3 border border-white/10 flex justify-between items-center">
                                            <div class="flex-1">
                                                <h3 class="text-white font-semibold text-sm">${w.name}</h3>
                                                <p class="text-purple-200 text-xs">${w.date} ‚Ä¢ ${w.exercises.length} exercises</p>
                                            </div>
                                            <button onclick="window.deleteWorkout('${w.id}')" class="p-2 bg-red-500/20 hover:bg-red-500/30 rounded text-red-200">üóëÔ∏è</button>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }
        }

        window.setUsername = setUsername;
        window.logout = logout;
        window.startWorkout = startWorkout;
        window.saveWorkout = saveWorkout;
        window.cancelWorkout = cancelWorkout;
        window.deleteWorkout = deleteWorkout;
        window.exportCSV = exportCSV;
        window.updateSet = updateSet;
        window.toggleComplete = toggleComplete;
        window.updateExerciseName = updateExerciseName;
        window.removeExercise = removeExercise;
        window.addExercise = addExercise;

        if (state.username) {
            loadWorkouts();
        } else {
            render();
        }
    </script>
</body>
</html>
